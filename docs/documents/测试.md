# 初赛测试

OS加载的第一个用户程序为`init_proc`,由`init_proc`加载`user_shell`，测试样例程序的由`user_shell`创建。



将测试样例，编译成二进制文件后，加载到文件系统中。在预加载的`user_shell`程序中结合`fork`，`exec`，`waitpid`系统调用逐个运行测试样例。

```
# user_shell.rs

fn auto_run_phase1() -> bool{
    let mut testsuits: Vec<&str> = Vec::new();
    testsuits.push("times\0");
    testsuits.push("gettimeofday\0");
    testsuits.push("sleep\0");
    testsuits.push("brk\0");
    testsuits.push("clone\0");
    testsuits.push("close\0");
    testsuits.push("dup2\0");
    testsuits.push("dup\0");
    testsuits.push("execve\0");
    testsuits.push("exit\0");
    testsuits.push("fork\0");
    testsuits.push("fstat\0");
    testsuits.push("getcwd\0");
    testsuits.push("getdents\0");
    testsuits.push("getpid\0");
    testsuits.push("getppid\0");
    testsuits.push("mkdir_\0");
    testsuits.push("mmap\0");
    testsuits.push("munmap\0");
    testsuits.push("mount\0");
    testsuits.push("openat\0");
    testsuits.push("open\0");
    testsuits.push("pipe\0");
    testsuits.push("read\0");
    testsuits.push("umount\0");
    testsuits.push("uname\0");
    testsuits.push("wait\0");
    testsuits.push("waitpid\0");
    testsuits.push("write\0");
    testsuits.push("yield\0");
    testsuits.push("unlink\0");
    testsuits.push("chdir\0");

    for programname in testsuits.iter(){
        let pid = fork();
        let mut exit_code = 0;
        let mut args_addr: Vec<*const u8> = Vec::new();
        args_addr.push(0 as *const u8);
        if pid == 0 {
            if exec(programname, args_addr.as_slice()) == -1 {
                println!("Error when executing run_testsuites!1");
                return false;
            }
            unreachable!();
        } else {
            waitpid(pid as usize, &mut exit_code);
        }
    }

    return false;
}
```



## 测试样例Debug过程

查找样例使用的系统调用https://github.com/oscomp/testsuits-for-oskernel/blob/final-comp/docs/busybox_musl_static_syscall.txt

或

获取单个二进制文件使用的系统调用号

```
# 从二进制文件中获取系统调用号
objdump -d objfile | grep -B 9 ecall | grep "li.a7" | tee syscall.txt
```



去内核里寻找对应实现，修改代码。